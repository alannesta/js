<html5>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<title>Debounce</title>
	<script src="script/jquery-1.8.3.js"></script>
</head>

<body>
	<script>
	
	var service = (function(){
		var queue = [];
		var oldlength = 0, newlength;

		var interval;
		var timeout;

		var now = Date.now || function(){
			return new Date().getTime();
		}
		var timestamp = now();
		var debounce_delay = 500;


		// function checkQueue(){
		// 	return setInterval(function(){
		// 		if ((newlength = queue.length) !== oldlength){
		// 			queue.pop()();
		// 			queue = [];
		// 			clearInterval(interval);
		// 			interval = null;
		// 		}
		// 	}, debounce_delay);
		// }

		// interval = checkQueue();	// kickstart

		function checkQueue_v3(callback){
			var diff = now() - timestamp;
			if (diff > debounce_delay){
				callback();
				clearInterval(interval);
				interval = null;
			}
		}

		function checkQueue_v2(callback){
			
			var diff = now() - timestamp;
			if (diff > debounce_delay){
				callback();	
			}else{
				clearTimeout(timeout);
				// setTimeout syntax: https://developer.mozilla.org/en-US/docs/Web/API/WindowTimers.setTimeout
				timeout = setTimeout(checkQueue_v2, debounce_delay, callback);	// check after a preset threshold
			}	
		}

		
		return {
			debounce: function(callback){

				// using setInterval(), push callback into job queue, less efficient
				return function(){
					if (interval){
						// console.log('setInterval already runnung');
						// console.log(interval);
					}else{
						// console.log('start interval');
						interval = checkQueue();
					}
					console.log('debounce!!!!')
					queue.push(callback);
				}
			},

			// setInterval timediff solution
			debounce_v3: function(callback){
				return function(){
					console.log('debounce_v3');
					timestamp = now();
					if (!interval){
						interval = setInterval(checkQueue_v3, debounce_delay, callback)
					}
				}
			},

			// using setTimeout()
			debounce_v2: function(callback){
				return function(){
					console.log('debounce_v2');
					timestamp = now();
					checkQueue_v2(callback);
				}
			}
		}

	})();

	// var debounce = service.debounce(function(){
	// 	console.log('resize');
	// });
	
	var debounce = service.debounce_v3(function(){
		console.log('resize');
	});

	$(window).on('resize', debounce);


	
	// underscore implementation

	// _.debounce = function(func) {
	//   var timeout, args, context, timestamp, result;

	//   var later = function() {
	//     var last = _.now() - timestamp;

	//     if (last >= 0) {
	//       timeout = setTimeout(later, last);
	//     } else {
	//       	timeout = null;
	//         result = func.apply(context, args);
	//         if (!timeout) context = args = null;
	//       }
	//     }
	//   };

	//   return function() {
	//     context = this;
	//     args = arguments;
	//     timestamp = _.now();
	//     if (!timeout) timeout = setTimeout(later, 0);
	//   };
	// };

  </script>
</body>
</html>




